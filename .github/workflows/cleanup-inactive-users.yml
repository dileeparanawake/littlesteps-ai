name: Cleanup inactive users

on:
  schedule:
    - cron: '0 3 1 * *' # 3 AM UTC on the 1st of each month
  workflow_dispatch: # manual trigger

permissions:
  id-token: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Mint OIDC token
        id: oidc
        run: |
          set -euo pipefail
          TOKEN=$(curl -sS \
            -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=api://littlesteps-ai" \
            | jq -r '.value')
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "::error::Failed to mint OIDC token"
            exit 1
          fi
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"

      - name: Trigger cleanup endpoint
        run: |
          RESPONSE=$(curl -sS --max-time 120 -f \
            -X POST \
            -H "Authorization: Bearer ${{ steps.oidc.outputs.token }}" \
            -H "Content-Type: application/json" \
            https://littlesteps-ai.com/api/admin/cleanup)
          echo "Response: $RESPONSE"
